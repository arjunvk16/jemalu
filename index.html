<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jemalu - The Word Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden {
            display: none;
        }
        .toast {
            animation: fade-in-out 3s ease-in-out forwards;
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .vote-button {
            transition: all 0.2s ease-in-out;
        }
        .vote-button:not(:disabled):hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <!-- Lobby Modal -->
    <div id="lobby-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-3xl font-bold mb-6 text-indigo-400">Jemalu</h2>
            <div class="space-y-4">
                <button id="show-host-modal-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Host New Game</button>
                <button id="show-join-modal-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Join Existing Game</button>
            </div>
        </div>
    </div>

    <!-- Host Name Entry Modal -->
    <div id="host-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6">Host a Game</h2>
            <input type="text" id="host-name-input" placeholder="Enter your name" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
            <button id="host-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Create Game</button>
        </div>
    </div>

    <!-- Join Game Modal -->
    <div id="join-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-6">Join a Game</h2>
            <input type="text" id="player-name-input" placeholder="Enter your name" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
            <input type="text" id="game-code-input" placeholder="Enter Game Code" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
            <button id="join-game-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Join Game</button>
        </div>
    </div>


    <!-- Main Game Container -->
    <div id="game-container" class="hidden w-full max-w-5xl mx-auto" data-phase="lobby">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-6 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <h1 class="text-3xl font-bold text-indigo-400">Jemalu</h1>
                <div class="text-center md:text-right">
                    <div id="game-code-display" class="text-lg font-semibold text-yellow-400 cursor-pointer" title="Click to copy"></div>
                    <div id="user-info" class="text-sm text-gray-400 mt-1"></div>
                </div>
            </header>

            <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Players List -->
                <div class="md:col-span-1 bg-gray-900/50 p-4 rounded-lg">
                    <h2 id="player-list-title" class="text-xl font-semibold mb-4">Players (<span id="player-count">0</span>/20)</h2>
                    <div id="players-list" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Player items will be injected here -->
                    </div>
                </div>

                <!-- Game Area -->
                <div id="game-area" class="md:col-span-2 bg-gray-900/50 p-6 rounded-lg flex flex-col items-center justify-center min-h-[300px]">
                    <!-- Word Display -->
                    <div id="word-display-container" class="text-center">
                        <p id="game-status" class="text-gray-400 mb-4">Welcome! Waiting for a host...</p>
                        <div id="word-display" class="text-5xl md:text-7xl font-bold tracking-widest text-yellow-400 break-all"></div>
                    </div>

                    <!-- Host Controls -->
                    <div id="host-controls" class="hidden w-full mt-4 space-y-4">
                        <div>
                           <label for="secret-word-input" class="block text-sm font-medium text-gray-300 mb-1">Enter Secret Word:</label>
                           <div class="flex gap-2">
                               <input type="text" id="secret-word-input" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                               <button id="generate-word-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md flex items-center justify-center transition duration-300">
                                   <span>Generate</span>
                               </button>
                           </div>
                        </div>
                        <button id="reveal-word-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Reveal Word to Selected</button>
                    </div>

                    <!-- Voting Area -->
                    <div id="voting-container" class="hidden w-full text-center">
                        <h3 class="text-2xl font-bold mb-4">Who is the Spy?</h3>
                        <div id="voting-players-list" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                            <!-- Voting buttons go here -->
                        </div>
                    </div>

                    <!-- Results Area -->
                    <div id="results-container" class="hidden w-full text-center">
                        <h3 class="text-3xl font-bold mb-4" id="results-title"></h3>
                        <p class="text-lg mb-6" id="results-subtitle"></p>
                        <div id="results-details" class="text-left bg-gray-800 p-4 rounded-lg"></div>
                    </div>

                </div>
            </main>

            <footer class="mt-6 pt-4 border-t border-gray-700 flex flex-wrap items-center justify-center gap-4">
                 <button id="become-host-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-6 rounded-md transition duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed">Become Host</button>
                 <button id="auto-manage-btn" class="hidden bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-md transition duration-300">Auto Manage</button>
                 <button id="start-voting-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">Start Voting</button>
                 <button id="reset-game-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">Reset Game</button>
            </footer>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 bg-indigo-600 text-white py-2 px-4 rounded-lg shadow-lg"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const lobbyModal = document.getElementById('lobby-modal');
        const hostModal = document.getElementById('host-modal');
        const joinModal = document.getElementById('join-modal');
        const showHostModalBtn = document.getElementById('show-host-modal-btn');
        const showJoinModalBtn = document.getElementById('show-join-modal-btn');
        const hostNameInput = document.getElementById('host-name-input');
        const hostGameBtn = document.getElementById('host-game-btn');
        const playerNameInput = document.getElementById('player-name-input');
        const gameCodeInput = document.getElementById('game-code-input');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameContainer = document.getElementById('game-container');
        const userInfo = document.getElementById('user-info');
        const gameCodeDisplay = document.getElementById('game-code-display');
        const playersList = document.getElementById('players-list');
        const playerListTitle = document.getElementById('player-list-title');
        const playerCount = document.getElementById('player-count');
        const becomeHostBtn = document.getElementById('become-host-btn');
        const autoManageBtn = document.getElementById('auto-manage-btn');
        const startVotingBtn = document.getElementById('start-voting-btn');
        const resetGameBtn = document.getElementById('reset-game-btn');
        const hostControls = document.getElementById('host-controls');
        const secretWordInput = document.getElementById('secret-word-input');
        const generateWordBtn = document.getElementById('generate-word-btn');
        const revealWordBtn = document.getElementById('reveal-word-btn');
        const gameStatus = document.getElementById('game-status');
        const wordDisplayContainer = document.getElementById('word-display-container');
        const wordDisplay = document.getElementById('word-display');
        const votingContainer = document.getElementById('voting-container');
        const votingPlayersList = document.getElementById('voting-players-list');
        const resultsContainer = document.getElementById('results-container');
        const resultsTitle = document.getElementById('results-title');
        const resultsSubtitle = document.getElementById('results-subtitle');
        const resultsDetails = document.getElementById('results-details');
        const toastNotification = document.getElementById('toast-notification');

        // --- FIREBASE AND APP CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const GEMINI_API_KEY = 'AIzaSyAEI4iMpOqIsfbSpY9lYlOKAgixUQXQ6ps';
        const MODEL_NAME="gemini-1.5-flash-latest";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jemalu-game-default';
        
        let db, auth;
        let userId, playerName, gameId;
        let allPlayers = [];
        let unsubscribePlayers, unsubscribeGameState;

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        await authenticateUser();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showToast("Could not connect to the game server.");
            }
        }
        
        async function authenticateUser() {
             if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
             } else {
                 await signInAnonymously(auth);
             }
        }

        // --- UI FLOW & GAME LOGIC ---
        function showToast(message) {
            toastNotification.textContent = message;
            toastNotification.classList.remove('hidden', 'toast');
            void toastNotification.offsetWidth;
            toastNotification.classList.add('toast');
        }

        // --- GEMINI API FUNCTION ---
        async function generateSecretWord() {
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = "Generate a single, funny, or sarcastic Malayalam word suitable for a word guessing game. Provide only the word in Malayalam script, with no English letters, translations, or explanations.";

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const word = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (word) {
                    return word.trim();
                } else {
                    throw new Error("Could not parse a word from the API response.");
                }
            } catch (error) {
                console.error("Error generating word with Gemini:", error);
                showToast("Failed to generate a word.");
                return null;
            }
        }


        async function hostGame() {
            playerName = hostNameInput.value.trim();
            if (!playerName) return showToast("Please enter a name.");
            if (!userId) return showToast("Authentication failed. Please wait.");
            
            gameId = Math.floor(100000 + Math.random() * 900000).toString();
            
            try {
                const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
                await setDoc(gameStateRef, {
                    phase: 'lobby',
                    createdAt: serverTimestamp()
                });
                await joinGame(true);
            } catch (error) {
                console.error("Error hosting game:", error);
                showToast("Could not host the game.");
            }
        }

        async function joinGame(isHosting = false) {
            if (!isHosting) {
                playerName = playerNameInput.value.trim();
                gameId = gameCodeInput.value.trim();
                if (!playerName || !gameId) return showToast("Please enter name and game code.");
            }
            if (!userId) return showToast("Authentication failed. Please wait.");

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
                const gameDoc = await getDoc(gameRef);
                if (!gameDoc.exists()) return showToast("Game not found.");

                const playerDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/players`, userId);
                await setDoc(playerDocRef, { name: playerName, joinedAt: serverTimestamp() });

                enterGameScreen();
            } catch (error) {
                console.error("Error joining game:", error);
                showToast("Could not join the game.");
            }
        }

        function enterGameScreen() {
            [lobbyModal, hostModal, joinModal].forEach(el => el.classList.add('hidden'));
            gameContainer.classList.remove('hidden');
            
            gameCodeDisplay.textContent = `Game Code: ${gameId}`;
            userInfo.textContent = `Your Name: ${playerName}`;

            listenToGame();
        }

        function listenToGame() {
            const playersCollectionRef = collection(db, `artifacts/${appId}/public/data/games/${gameId}/players`);
            unsubscribePlayers = onSnapshot(playersCollectionRef, (snapshot) => {
                allPlayers = [];
                snapshot.forEach(doc => allPlayers.push({ id: doc.id, ...doc.data() }));
            });
            
            const gameStateDocRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            unsubscribeGameState = onSnapshot(gameStateDocRef, (doc) => {
                const gameState = doc.exists() ? doc.data() : {};
                updateUI(gameState);
            });
        }

        function updatePlayersList(gameState = {}) {
            playersList.innerHTML = '';
            playerCount.textContent = allPlayers.length;

            const isHost = document.body.dataset.isHost === 'true';
            const phase = gameContainer.dataset.phase;

            let playersToRender = [...allPlayers];
            
            if (gameState.turnOrder && gameState.turnOrder.length > 0) {
                 playerListTitle.textContent = "Turn Order";
                 playersToRender.sort((a, b) => gameState.turnOrder.indexOf(a.id) - gameState.turnOrder.indexOf(b.id));
            } else {
                playerListTitle.textContent = `Players (${allPlayers.length}/20)`;
                playersToRender.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            playersToRender.forEach((p, index) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-md';
                const isYou = p.id === userId;

                let checkboxHTML = '';
                if (isHost && phase === 'word_selection' && p.id !== userId) {
                    checkboxHTML = `<input type="checkbox" data-player-id="${p.id}" class="player-checkbox form-checkbox h-5 w-5 bg-gray-800 border-gray-600 rounded text-indigo-500 focus:ring-indigo-500">`;
                }
                
                const turnOrderPrefix = gameState.turnOrder ? `${index + 1}. ` : '';

                playerElement.innerHTML = `
                    <span class="font-medium ${isYou ? 'text-yellow-300' : ''}">${turnOrderPrefix}${p.name} ${isYou ? '(You)' : ''}</span>
                    ${checkboxHTML}
                `;
                playersList.appendChild(playerElement);
            });
        }

        function updateUI(gameState) {
            const isHost = gameState.hostId === userId;
            const isOriginalHost = gameState.originalHostId === userId;
            document.body.dataset.isHost = isHost;
            gameContainer.dataset.phase = gameState.phase || 'lobby';

            updatePlayersList(gameState);

            [hostControls, wordDisplayContainer, votingContainer, resultsContainer, startVotingBtn, autoManageBtn].forEach(el => el.classList.add('hidden'));
            
            becomeHostBtn.disabled = !!gameState.hostId || !!gameState.autoManaged;
            resetGameBtn.classList.toggle('hidden', !isHost && !isOriginalHost);
            
            if((isHost || isOriginalHost) && allPlayers.length <= 5){
                 autoManageBtn.classList.remove('hidden');
                 autoManageBtn.textContent = gameState.autoManaged ? "Next Auto Round" : "Auto Manage";
            }

            switch (gameState.phase) {
                case 'lobby':
                    wordDisplayContainer.classList.remove('hidden');
                    gameStatus.textContent = gameState.hostId ? `Waiting for ${gameState.hostName} to set a word...` : "Waiting for a player to become host.";
                    wordDisplay.textContent = '';
                    break;
                case 'word_selection':
                    if (isHost) hostControls.classList.remove('hidden');
                    wordDisplayContainer.classList.remove('hidden');
                    gameStatus.textContent = isHost ? "Enter a word and select players who are NOT spies." : `Waiting for ${gameState.hostName} to set a word...`;
                    wordDisplay.textContent = '';
                    break;
                case 'revealed':
                    wordDisplayContainer.classList.remove('hidden');
                    if (isHost && !gameState.autoManaged) startVotingBtn.classList.remove('hidden');

                    const amISpy = gameState.spyIds?.includes(userId);
                    
                    if (amISpy) {
                        gameStatus.textContent = `You are a Spy!`;
                        wordDisplay.textContent = "••••••";
                    } else {
                        gameStatus.textContent = `The secret word is:`;
                        wordDisplay.textContent = gameState.secretWord;
                    }
                    
                    // Auto-trigger voting for auto-managed games
                    if(gameState.autoManaged && (isHost || isOriginalHost)) {
                        setTimeout(() => startVoting(), 3000); // Give players a moment to see the word
                    }

                    break;
                case 'voting':
                    votingContainer.classList.remove('hidden');
                    renderVotingList(gameState);
                    break;
                case 'results':
                    resultsContainer.classList.remove('hidden');
                    renderResults(gameState);
                    break;
            }
        }
        
        function renderVotingList(gameState) {
            votingPlayersList.innerHTML = '';
            const myVote = gameState.votes?.[userId];
            const playersWhoHaveVoted = Object.keys(gameState.votes || {});

            let votablePlayers, totalVoters;
            if (gameState.autoManaged) {
                votablePlayers = allPlayers;
                totalVoters = allPlayers.length;
            } else {
                votablePlayers = allPlayers.filter(p => p.id !== gameState.hostId);
                totalVoters = allPlayers.length - 1;
            }

            votablePlayers.forEach(p => {
                const button = document.createElement('button');
                button.textContent = p.name;
                button.dataset.playerId = p.id;
                button.className = 'vote-button w-full p-3 rounded-md bg-indigo-600 hover:bg-indigo-500 disabled:bg-gray-500 disabled:opacity-75 disabled:cursor-not-allowed';
                button.disabled = !!myVote || p.id === userId;
                if (p.id === userId) button.textContent = "You (Can't vote for self)";

                if (myVote === p.id) {
                    button.classList.replace('bg-indigo-600', 'bg-green-600');
                    button.textContent = `Voted for ${p.name}`;
                }
                button.addEventListener('click', () => castVote(p.id));
                votingPlayersList.appendChild(button);
            });
            gameStatus.textContent = `Votes cast: ${playersWhoHaveVoted.length} / ${totalVoters}`;
        }

        function renderResults(gameState) {
            resultsTitle.textContent = gameState.results.title;
            resultsSubtitle.textContent = gameState.results.subtitle;
            
            let detailsHTML = '<ul>';
            const voteCounts = gameState.results.voteCounts;
            for (const playerId in voteCounts) {
                if (voteCounts.hasOwnProperty(playerId)) {
                    const playerName = allPlayers.find(p => p.id === playerId)?.name || 'Unknown';
                    const isSpy = gameState.spyIds.includes(playerId);
                    detailsHTML += `<li class="mb-1"><span class="font-bold">${playerName}</span> received ${voteCounts[playerId]} vote(s) ${isSpy ? '<span class="text-red-400 font-semibold">(Spy)</span>' : ''}</li>`;
                }
            }
            detailsHTML += '</ul>';
            resultsDetails.innerHTML = detailsHTML;
        }

        async function becomeHost() {
            if (!userId || !playerName) return;
            const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            try {
                await runTransaction(db, async (transaction) => {
                    const gameStateDoc = await transaction.get(gameStateRef);
                    if (gameStateDoc.data().hostId) throw new Error("Host already exists.");
                    transaction.update(gameStateRef, { hostId: userId, hostName: playerName, phase: 'word_selection' });
                });
                showToast("You are now the host!");
            } catch (error) {
                showToast("Another player just became host!");
                console.error("Failed to become host:", error.message);
            }
        }

        async function revealWord() {
            const secretWord = secretWordInput.value.trim();
            if (!secretWord) return showToast("Please enter a secret word.");

            const selectedCheckboxes = document.querySelectorAll('.player-checkbox:checked');
            const selectedPlayerIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.playerId);
            if (selectedPlayerIds.length === 0) return showToast("Please select at least one player (who is not a spy).");

            const allPlayerIds = allPlayers.map(p => p.id);
            const spyIds = allPlayerIds.filter(id => id !== userId && !selectedPlayerIds.includes(id));

            const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            try {
                await updateDoc(gameStateRef, {
                    secretWord,
                    selectedPlayerIds,
                    spyIds,
                    phase: 'revealed',
                    votes: {}
                });
            } catch (error) {
                console.error("Error revealing word:", error);
                showToast("Could not reveal the word.");
            }
        }
        
        async function toggleAutoManage() {
            if (allPlayers.length < 2) return showToast("Need at least 2 players for auto mode.");
            
            autoManageBtn.disabled = true;
            autoManageBtn.innerHTML = '<div class="loader"></div>';

            const secretWord = await generateSecretWord();

            if(!secretWord) {
                autoManageBtn.disabled = false;
                autoManageBtn.textContent = 'Auto Manage';
                return; // Error toast is shown in the generate function
            }

            const playerIds = allPlayers.map(p => p.id);
            const spyIndex = Math.floor(Math.random() * playerIds.length);
            const spyId = playerIds[spyIndex];

            let turnOrder = [...playerIds].sort(() => Math.random() - 0.5);
            while(turnOrder[0] === spyId && playerIds.length > 1) {
                turnOrder.push(turnOrder.shift());
            }

            const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            try {
                 await updateDoc(gameStateRef, {
                    autoManaged: true,
                    hostId: 'auto-host',
                    originalHostId: userId,
                    hostName: 'Auto Host',
                    phase: 'revealed',
                    spyIds: [spyId],
                    secretWord: secretWord,
                    turnOrder: turnOrder,
                    votes: {},
                    results: null,
                });
                showToast("Auto round started! Check the turn order.");
            } catch (error) {
                console.error("Error starting auto-manage:", error);
                showToast("Could not start auto-managed game.");
            } finally {
                autoManageBtn.disabled = false;
                autoManageBtn.textContent = 'Next Auto Round';
            }
        }

        async function startVoting() {
            const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            await updateDoc(gameStateRef, { phase: 'voting' });
        }

        async function castVote(votedForPlayerId) {
            const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            try {
                await runTransaction(db, async (transaction) => {
                    const gameStateDoc = await transaction.get(gameStateRef);
                    if (!gameStateDoc.exists()) throw new Error("Game state not found.");
                    
                    const gameState = gameStateDoc.data();
                    if (gameState.votes[userId]) throw new Error("Already voted.");

                    const newVotes = { ...gameState.votes, [userId]: votedForPlayerId };
                    
                    let totalVoters = gameState.autoManaged ? allPlayers.length : allPlayers.length - 1;

                    if (Object.keys(newVotes).length >= totalVoters) {
                        calculateAndSetResults(gameState, newVotes, transaction, gameStateRef);
                    } else {
                        transaction.update(gameStateRef, { votes: newVotes });
                    }
                });
            } catch (error) {
                showToast(error.message);
                console.error("Error casting vote:", error);
            }
        }

        function calculateAndSetResults(gameState, votes, transaction, ref) {
            const voteCounts = {};
            Object.values(votes).forEach(votedForId => {
                voteCounts[votedForId] = (voteCounts[votedForId] || 0) + 1;
            });

            let maxVotes = 0;
            let mostVotedPlayerIds = [];
            for (const playerId in voteCounts) {
                if(voteCounts[playerId] > maxVotes) {
                    maxVotes = voteCounts[playerId];
                    mostVotedPlayerIds = [playerId];
                } else if (voteCounts[playerId] === maxVotes) {
                    mostVotedPlayerIds.push(playerId);
                }
            }

            const spyIds = gameState.spyIds || [];
            const wasSpyCaught = mostVotedPlayerIds.some(id => spyIds.includes(id));
            
            let results = {};
            if (wasSpyCaught) {
                const caughtSpyNames = mostVotedPlayerIds.filter(id => spyIds.includes(id))
                    .map(id => allPlayers.find(p => p.id === id)?.name).join(', ');
                results = {
                    title: `Spy Caught! It was ${caughtSpyNames}.`,
                    subtitle: "The villagers win!",
                    voteCounts
                };
            } else {
                const spyNames = spyIds.map(id => allPlayers.find(p => p.id === id)?.name).join(', ');
                results = {
                    title: `Spy Wins! It was ${spyNames}.`,
                    subtitle: "The spy successfully deceived everyone.",
                    voteCounts
                };
            }

            transaction.update(ref, { phase: 'results', results });
        }
        
        async function resetGame() {
            const gameStateRef = doc(db, `artifacts/${appId}/public/data/games/${gameId}/gameState/main`);
            try {
                await updateDoc(gameStateRef, {
                    hostId: null, hostName: null, phase: 'lobby',
                    secretWord: null, selectedPlayerIds: [], spyIds: [],
                    votes: {}, results: null, autoManaged: false, originalHostId: null, turnOrder: []
                });
                secretWordInput.value = '';
                showToast("Game has been reset.");
            } catch (error) {
                console.error("Error resetting game:", error);
                showToast("Failed to reset the game.");
            }
        }

        // --- EVENT LISTENERS ---
        showHostModalBtn.addEventListener('click', () => { hostModal.classList.remove('hidden'); });
        showJoinModalBtn.addEventListener('click', () => { joinModal.classList.remove('hidden'); });
        hostGameBtn.addEventListener('click', hostGame);
        joinGameBtn.addEventListener('click', () => joinGame(false));
        becomeHostBtn.addEventListener('click', becomeHost);
        resetGameBtn.addEventListener('click', resetGame);
        revealWordBtn.addEventListener('click', revealWord);
        startVotingBtn.addEventListener('click', startVoting);
        autoManageBtn.addEventListener('click', toggleAutoManage);
        
        generateWordBtn.addEventListener('click', async () => {
            generateWordBtn.disabled = true;
            generateWordBtn.innerHTML = '<div class="loader"></div>';
            const word = await generateSecretWord();
            if (word) {
                secretWordInput.value = word;
            }
            generateWordBtn.disabled = false;
            generateWordBtn.innerHTML = '<span>Generate</span>';
        });

        gameCodeDisplay.addEventListener('click', () => {
            navigator.clipboard.writeText(gameId).then(() => showToast('Game code copied!'));
        });
        
        // --- INITIALIZE ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>

